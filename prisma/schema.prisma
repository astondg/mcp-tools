// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ==========================================
// Vehicle Maintenance Tracking System
// ==========================================

model Vehicle {
  id              String   @id @default(uuid())
  name            String   // Display name (e.g., "Family SUV")
  make            String   // Manufacturer (e.g., "Toyota")
  model           String   // Model name (e.g., "RAV4")
  year            Int?     // Model year
  vin             String?  @unique // Vehicle Identification Number
  licensePlate    String?  @map("license_plate")
  currentOdometer Int      @default(0) @map("current_odometer") // In kilometers
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  serviceRecords       ServiceRecord[]
  maintenanceSchedules MaintenanceSchedule[]

  @@map("vehicles")
}

model ServiceRecord {
  id          String   @id @default(uuid())
  vehicleId   String   @map("vehicle_id")
  serviceDate DateTime @map("service_date") @db.Date
  serviceType String   @map("service_type") // e.g., 'oil_change', 'tire_rotation'
  odometer    Int?     // Odometer reading at time of service (km)
  cost              Decimal? @db.Decimal(10, 2) // Amount actually paid
  serviceTotalValue Decimal? @map("service_total_value") @db.Decimal(10, 2) // Total value of service (before service plan coverage)
  provider          String?  // Service provider name
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  vehicle      Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  serviceParts ServicePart[]

  @@map("service_records")
}

model Part {
  id           String   @id @default(uuid())
  name         String   // Part name (e.g., "Spark Plug")
  manufacturer String?  // Brand (e.g., "NGK")
  model        String?  // Model name
  partNumber   String?  @map("part_number") // OEM/aftermarket part number
  description  String?
  cost         Decimal? @db.Decimal(10, 2) // Unit cost
  url          String?  // Link to product page
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  serviceParts ServicePart[]

  @@map("parts")
}

model ServicePart {
  id              String   @id @default(uuid())
  serviceRecordId String   @map("service_record_id")
  partId          String   @map("part_id")
  quantity        Int      @default(1)
  costPerUnit     Decimal? @map("cost_per_unit") @db.Decimal(10, 2) // Cost at time of service
  notes           String?

  // Relations
  serviceRecord ServiceRecord @relation(fields: [serviceRecordId], references: [id], onDelete: Cascade)
  part          Part          @relation(fields: [partId], references: [id])

  @@map("service_parts")
}

model MaintenanceSchedule {
  id                    String    @id @default(uuid())
  vehicleId             String    @map("vehicle_id")
  name                  String    // Schedule name (e.g., "Oil Change")
  serviceType           String    @map("service_type") // Matches service record types
  intervalKm            Int?      @map("interval_km") // Every X kilometers
  intervalMonths        Int?      @map("interval_months") // Every X months
  lastPerformedDate     DateTime? @map("last_performed_date") @db.Date
  lastPerformedOdometer Int?      @map("last_performed_odometer")
  enabled               Boolean   @default(true)
  notes                 String?
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("maintenance_schedules")
}

// ==========================================
// Budget & Expense Tracking System
// ==========================================

enum BudgetPeriod {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum ExpenseSource {
  MANUAL
  BANK_IMPORT
}

enum RuleMatchType {
  CONTAINS
  STARTS_WITH
  REGEX
}

model BudgetCategory {
  id           String         @id @default(uuid())
  name         String         @unique
  parentId     String?        @map("parent_id")
  period       BudgetPeriod
  budgetAmount Decimal        @map("budget_amount") @db.Decimal(10, 2)
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Relations
  parent   BudgetCategory?      @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children BudgetCategory[]     @relation("CategoryHierarchy")
  expenses Expense[]
  rules    CategorizationRule[]

  @@map("budget_categories")
}

model Expense {
  id            String        @id @default(uuid())
  date          DateTime      @db.Date
  amount        Decimal       @db.Decimal(10, 2)
  categoryId    String        @map("category_id")
  description   String
  merchantName  String?       @map("merchant_name")
  source        ExpenseSource @default(MANUAL)
  bankReference String?       @unique @map("bank_reference")
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  category BudgetCategory @relation(fields: [categoryId], references: [id])

  @@map("expenses")
}

model CategorizationRule {
  id         String        @id @default(uuid())
  pattern    String
  matchType  RuleMatchType @default(CONTAINS) @map("match_type")
  categoryId String        @map("category_id")
  priority   Int           @default(0)
  isActive   Boolean       @default(true) @map("is_active")
  createdAt  DateTime      @default(now()) @map("created_at")

  // Relations
  category BudgetCategory @relation(fields: [categoryId], references: [id])

  @@map("categorization_rules")
}

model IncomeSource {
  id             String   @id @default(uuid())
  name           String   @unique
  expectedAmount Decimal  @map("expected_amount") @db.Decimal(10, 2)
  payDay         Int      @map("pay_day") // Day of month (1-31, 31 = last day)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  incomes Income[]

  @@map("income_sources")
}

model Income {
  id            String   @id @default(uuid())
  date          DateTime @db.Date
  amount        Decimal  @db.Decimal(10, 2)
  sourceId      String   @map("source_id")
  description   String?
  bankReference String?  @unique @map("bank_reference")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  source IncomeSource @relation(fields: [sourceId], references: [id])

  @@map("incomes")
}

// ==========================================
// Shopping & Purchase Intelligence System
// ==========================================

enum WishlistPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PurchaseSource {
  MANUAL
  EXPENSE_IMPORT // Linked to an expense record
}

model PurchaseCategory {
  id        String            @id @default(uuid())
  name      String            @unique
  parentId  String?           @map("parent_id")
  createdAt DateTime          @default(now()) @map("created_at")

  // Relations
  parent    PurchaseCategory?  @relation("PurchaseCategoryHierarchy", fields: [parentId], references: [id])
  children  PurchaseCategory[] @relation("PurchaseCategoryHierarchy")
  purchases PurchaseHistory[]
  wishlist  WishlistItem[]

  @@map("purchase_categories")
}

model PurchaseHistory {
  id            String          @id @default(uuid())
  purchaseDate  DateTime        @map("purchase_date") @db.Date
  itemName      String          @map("item_name")
  categoryId    String          @map("category_id")
  price         Decimal         @db.Decimal(10, 2)
  quantity      Int             @default(1)
  merchant      String?
  brand         String?
  productUrl    String?         @map("product_url")
  source        PurchaseSource  @default(MANUAL)
  expenseId     String?         @unique @map("expense_id") // Link to expense if imported
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  category PurchaseCategory @relation(fields: [categoryId], references: [id])

  @@index([purchaseDate])
  @@index([categoryId])
  @@index([merchant])
  @@index([brand])
  @@map("purchase_history")
}

model WishlistItem {
  id           String            @id @default(uuid())
  itemName     String            @map("item_name")
  categoryId   String            @map("category_id")
  targetPrice  Decimal?          @map("target_price") @db.Decimal(10, 2)
  priority     WishlistPriority  @default(MEDIUM)
  brand        String?
  specifications String?        // JSON or text for specific requirements
  productUrl   String?           @map("product_url")
  notes        String?
  isActive     Boolean           @default(true) @map("is_active")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  // Relations
  category PurchaseCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([priority])
  @@index([isActive])
  @@map("wishlist_items")
}

model ShoppingProfile {
  id                    String   @id @default(uuid())
  profileName           String   @unique @map("profile_name") @default("default")
  preferredMerchants    String?  @map("preferred_merchants") // JSON array
  avoidedMerchants      String?  @map("avoided_merchants") // JSON array
  preferredBrands       String?  @map("preferred_brands") // JSON array
  categoryPreferences   String?  @map("category_preferences") // JSON object with category weights
  priceThresholds       String?  @map("price_thresholds") // JSON object with category-based thresholds
  dealVoteMinimum       Int      @default(10) @map("deal_vote_minimum") // Minimum votes for deals
  notificationSettings  String?  @map("notification_settings") // JSON for preferences
  lastAnalyzed          DateTime @default(now()) @map("last_analyzed")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("shopping_profiles")
}

// ==========================================
// Better Auth - Official schema generated by CLI
// Generated with: npx @better-auth/cli generate
// ==========================================

model User {
  id                String             @id
  name              String
  email             String
  emailVerified     Boolean            @default(false)
  image             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  sessions          Session[]
  accounts          Account[]
  oauthApplications OauthApplication[]
  oauthAccessTokens OauthAccessToken[]
  oauthConsents     OauthConsent[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model OauthApplication {
  id                String             @id
  name              String?
  icon              String?
  metadata          String?
  clientId          String?
  clientSecret      String?
  redirectUrls      String?
  type              String?
  disabled          Boolean?           @default(false)
  userId            String?
  user              User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime?
  updatedAt         DateTime?
  oauthAccessTokens OauthAccessToken[]
  oauthConsents     OauthConsent[]

  @@unique([clientId])
  @@index([userId])
  @@map("oauthApplication")
}

model OauthAccessToken {
  id                    String            @id
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  clientId              String?
  oauthApplication      OauthApplication? @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  userId                String?
  user                  User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  scopes                String?
  createdAt             DateTime?
  updatedAt             DateTime?

  @@unique([accessToken])
  @@unique([refreshToken])
  @@index([clientId])
  @@index([userId])
  @@map("oauthAccessToken")
}

model OauthConsent {
  id               String            @id
  clientId         String?
  oauthApplication OauthApplication? @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  userId           String?
  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  scopes           String?
  createdAt        DateTime?
  updatedAt        DateTime?
  consentGiven     Boolean?

  @@index([clientId])
  @@index([userId])
  @@map("oauthConsent")
}
